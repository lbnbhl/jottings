## 学问项目

> 这是一个springboot项目
>
> http://insidexcc.xsbg.com/



### pom文件分析

~~~xml
    <dependencies>
<!-- 图数据库，知识图谱 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-neo4j</artifactId>
        </dependency>
        <dependency>
            <groupId>org.neo4j.driver</groupId>
            <artifactId>neo4j-java-driver</artifactId>
        </dependency>
        
<!--   chatgpt     -->     
        <dependency>
            <groupId>com.unfbx</groupId>
            <artifactId>chatgpt-java</artifactId>
            <version>1.0.12</version>
            <exclusions>
                <exclusion>
                    <groupId>org.slf4j</groupId>
                    <artifactId>slf4j-simple</artifactId>
                </exclusion>
            </exclusions>
        </dependency>
        
<!--   websocket     -->        
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-websocket</artifactId>
        </dependency>
        
<!-- 二维码 -->
        <dependency>
            <groupId>com.google.zxing</groupId>
            <artifactId>core</artifactId>
            <version>3.3.0</version>
        </dependency>
        <dependency>
            <groupId>com.google.zxing</groupId>
            <artifactId>javase</artifactId>
            <version>3.3.0</version>
        </dependency>
        
<!--        通过ip获得归属地-->
        <dependency>
            <groupId>org.lionsoul</groupId>
            <artifactId>ip2region</artifactId>
            <version>1.7.2</version>
        </dependency>

        <!--        阿里云osssdk-->
        <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
            <version>3.10.2</version>
        </dependency>
        <!--        阿里云短信服务-->
        <!--  升级版 SDK  -->
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>dysmsapi20170525</artifactId>
            <version>2.0.10</version>
        </dependency>
        <!-- https://mvnrepository.com/artifact/com.aliyun/aliyun-java-sdk-core -->
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-java-sdk-core</artifactId>
            <version>4.4.3</version>
        </dependency>

        <!-- java词云生成 -->
        <dependency>
            <groupId>com.kennycason</groupId>
            <artifactId>kumo-core</artifactId>
            <version>1.28</version>
        </dependency>
        <dependency>
            <groupId>com.kennycason</groupId>
            <artifactId>kumo-tokenizers</artifactId>
            <version>1.28</version>
        </dependency>

        <!-- Knife4j是为Java MVC框架集成Swagger生成Api文档的增强解决方案 -->
        <dependency>
            <groupId>com.github.xiaoymin</groupId>
            <artifactId>knife4j-spring-boot-starter</artifactId>
            <version>2.0.9</version>
        </dependency>
        
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
            <version>3.4.1</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <!-- druid 连接池 -->
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>druid</artifactId>
            <version>1.1.12</version>
        </dependency>
        <!-- H2数据库是一个开源的关系型数据库 -->
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>runtime</scope>
        </dependency>
        <!-- java工具类库 -->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
            <version>5.5.4</version>
        </dependency>
        <!-- 分页查询插件 -->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.12</version>
        </dependency>

        <dependency>
            <groupId>org.elasticsearch</groupId>
            <artifactId>elasticsearch</artifactId>
            <version>${elasticsearch.version}</version>
        </dependency>
        <dependency>
            <groupId>org.elasticsearch.client</groupId>
            <artifactId>elasticsearch-rest-client</artifactId>
            <version>${elasticsearch.version}</version>
        </dependency>
        <!-- Java High Level REST Client -->
        <dependency>
            <groupId>org.elasticsearch.client</groupId>
            <artifactId>elasticsearch-rest-high-level-client</artifactId>
            <version>${elasticsearch.version}</version>
        </dependency>
        <dependency>
            <groupId>junit</groupId>
            <artifactId>junit</artifactId>
            <version>4.12</version>
            <scope>test</scope>
        </dependency>
        <!-- GSON是Google提供的用来在Java对象和JSON数据之间进行映射的Java类库 -->
        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>2.8.6</version>
        </dependency>

        <!--zhangfurong JJWT的是在JVM上创建和验证JSON Web Token(JWTs)的库。-->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>0.9.1</version>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>
        <dependency>
            <groupId>com.auth0</groupId>
            <artifactId>java-jwt</artifactId>
            <version>3.4.0</version>
        </dependency>
        <!-- 邮件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-mail</artifactId>
        </dependency>

        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>persistence-api</artifactId>
            <version>1.0</version>
        </dependency>

        <dependency>
            <groupId>log4j</groupId>
            <artifactId>log4j</artifactId>
            <version>1.2.17</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>servlet-api</artifactId>
            <version>2.5</version>
        </dependency>
        <dependency>
            <groupId>javax.servlet</groupId>
            <artifactId>javax.servlet-api</artifactId>
            <version>4.0.1</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.58</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
        <dependency>
            <groupId>redis.clients</groupId>
            <artifactId>jedis</artifactId>
            <version>3.2.0</version>
        </dependency>
        <!-- 汉字转拼音 -->
        <dependency>
            <groupId>com.belerweb</groupId>
            <artifactId>pinyin4j</artifactId>
            <version>2.5.1</version>
        </dependency>

        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.3.2</version>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-generator</artifactId>
            <version>3.3.2</version>
        </dependency>

        <!--    mysql 持久层-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <!-- velocity 模板引擎, Mybatis Plus 代码生成器需要 -->
        <dependency>
            <groupId>org.apache.velocity</groupId>
            <artifactId>velocity-engine-core</artifactId>
            <version>2.3</version>
        </dependency>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-extension</artifactId>
            <version>3.3.2</version>
        </dependency>

        <dependency>
            <groupId>com.alipay.sdk</groupId>
            <artifactId>alipay-sdk-java</artifactId>
            <version>4.35.9.ALL</version>
        </dependency>

        <!--    mybatis Plus 多数据源    -->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
            <version>3.4.1</version>
        </dependency>


    </dependencies>
~~~



### 数据表分析



### 项目结构

![image-20230728134254087](C:\Users\ZHL\AppData\Roaming\Typora\typora-user-images\image-20230728134254087.png)





### 配置信息

~~~Java
//es配置
@Configuration
public class ElasticsearchRestClient {

    /**
     * ES地址,ip:port
     */
    @Value("${elasticsearch.ip}")
    String ipPort;
    @Value("${elasticsearch.user}")
    String user;
    @Value("${elasticsearch.password}")
    String password;

    @Bean
    public RestClientBuilder restClientBuilder() {
        final CredentialsProvider credentialsProvider = new BasicCredentialsProvider();
        credentialsProvider.setCredentials(AuthScope.ANY,
                new UsernamePasswordCredentials(user, password));
        return RestClient.builder(makeHttpHost(ipPort))
                .setHttpClientConfigCallback(new RestClientBuilder.HttpClientConfigCallback() {
                    @Override
                    public HttpAsyncClientBuilder customizeHttpClient(HttpAsyncClientBuilder httpClientBuilder) {
                        return httpClientBuilder.setDefaultCredentialsProvider(credentialsProvider);
                    }
                });
    }

    @Bean(name = "highLevelClient")
    public RestHighLevelClient highLevelClient(@Autowired RestClientBuilder restClientBuilder) {
        return new RestHighLevelClient(restClientBuilder);
    }

    private HttpHost makeHttpHost(String s) {
        String[] address = s.split(":");
        String ip = address[0];
        int port = Integer.parseInt(address[1]);
        return new HttpHost(ip, port, "http");
    }
}

//swagger配置
@Configuration
@EnableSwagger2WebMvc
public class SwaggerConfig {
    // 创建Docket存入容器，Docket代表一个接口文档
    @Bean
    public Docket webApiConfig(){
        return new Docket(DocumentationType.SWAGGER_2)
                // 创建接口文档的具体信息
                .apiInfo(webApiInfo())
                // 创建选择器，控制哪些接口被加入文档
                .select()
                // 指定@ApiOperation标注的接口被加入文档
                .apis(RequestHandlerSelectors.withMethodAnnotation(ApiOperation.class))
                .build();
    }

    // 创建接口文档的具体信息，会显示在接口文档页面中
    private ApiInfo webApiInfo(){
        return new ApiInfoBuilder()
                // 文档标题
                .title("学查查系统接口文档")
                // 文档描述
                .description("描述：本文档描述了学查查系统的接口定义")
                // 版本
                .version("1.0")
                // 联系人信息
                .contact(new Contact("baobao", "http://baobao.com", "baobao@qq.com"))
                // 版权
                .license("baobao")
                // 版权地址
                .licenseUrl("http://www.baobao.com")
                .build();
    }
}

//配置多个mongodb库
@Configuration
public class MultipleMongoConfig {
    @Primary
    @Bean(name = "primary")
    @ConfigurationProperties(prefix = "spring.data.mongodb")
    public MongoProperties getPrimary() {
        return new MongoProperties();
    }
    @Bean(name = "secondary")
    @ConfigurationProperties(prefix = "zhaopinmongo")
    public MongoProperties getSecondary() {
        return new MongoProperties();
    }
    @Primary
    @Bean(name = "MongoTemplate")
    public MongoTemplate primaryMongoTemplate() throws Exception {
        return new MongoTemplate(primaryFactory(getPrimary()));
    }
    @Bean(name = "zhaopinMongoTemplate")
    public MongoTemplate secondaryMongoTemplate() throws Exception {
        return new MongoTemplate(secondaryFactory(getSecondary()));
    }
    @Bean
    @Primary
    public MongoDatabaseFactory primaryFactory(final MongoProperties mongo) throws Exception {
        return new SimpleMongoClientDatabaseFactory(mongo.getUri());
    }
    @Bean
    public MongoDatabaseFactory secondaryFactory(final MongoProperties mongo) throws Exception {
        System.out.println(mongo.getUri());
        return new SimpleMongoClientDatabaseFactory(mongo.getUri());
    }
}


~~~



### 业务分析

![image-20230818165839469](C:\Users\ZHL\AppData\Roaming\Typora\typora-user-images\image-20230818165839469.png)

分为学者、文献、基金、工作、网络、学知等模块

#### 学者

#### 文献

#### 基金

#### 工作

#### 学知

### 调试接口

[学查查系统接口文档](http://localhost:8060/doc.html#/home)

#### CaptchaController

> 验证码



#### ChatController

> gpt接口

- 创建sse连接 /gpt/createSse

  - 过程

    ~~~java
        /**
         * 创建sse连接
         * @param headers
         * @return 返回一个SseEmitter对象，SseEmitter 是 Spring Framework 中提供的一个类，用于支持 Server-Sent Events (SSE)。SSE 是一种客户端与服务器之间的单向通信机制，允许服务器向客户端推送实时消息
         */
        @CrossOrigin
        @GetMapping("/createSse")
        public SseEmitter createConnect(@RequestHeader Map<String, String> headers) {
            String uid = UserHolder.get();
            return sseService.createSse(uid);
        }
    ~~~

- 关闭sse连接 /gpt/closeSse

- 聊天接口 /gpt//chat

  - 过程

    ~~~java
        /**
         * 聊天接口
         * @param chatRequest
         * @param headers
         */
        @CrossOrigin
        @PostMapping("/chat")
        @ResponseBody
        public ChatResponse sseChat(@RequestBody ChatRequest chatRequest, @RequestHeader Map<String, String> headers, HttpServletResponse response) {
            String uid = UserHolder.get();
            //获得聊天响应信息
            ChatResponse chatResponse = sseService.sseChat(uid, chatRequest);
            //记录问题到mongodb
            GPTQuestions gptQuestions = new GPTQuestions(null, uid, chatRequest.getMsg(), new Date());
            mongoTemplate.insert(gptQuestions);
            return chatResponse;
        }
    ~~~
    
  
- websocket接口 /gpt/websocket

  ~~~java
  public String websocket() {
          return "websocket.html";
      }
  ~~~

  

#### CiteController



- /cite//chinese_cite/{id}

  - 过程

    ~~~java
        /**
         * @param id
         * @return
         */
        @GetMapping("/chinese_cite/{id}")
        public R findPaper(HttpServletRequest request, @PathVariable("id") String id){
            String userId = JWTUtils.getUserIdByRequest(request);
            HashMap<String, Object> papers = citeService.selectPaper(userId, id);
            return R.ok().data(papers);
        }
    ~~~

    

#### home-controller

- 获取首页推荐论文 /home/getRecommendPaper

  > 获取登录用户所感兴趣学科的前5个期刊编号里的随机10篇论文，若没有感兴趣的或者未登录的，就所有期刊里随机10篇论文

- 首页查询 /home/search

  > 根据查询条件返回对应的学者信息，构造学者是否被关注的查询方法 避免多次查询数据库

- 获取首页学科 /home/getAllSubject

  - 涉及到的表:学科分类表
  
    ![image-20230529112111627](C:\Users\ZHL\AppData\Roaming\Typora\typora-user-images\image-20230529112111627.png)
  
  - 过程
  
    ~~~java
        public R getAllSubject() {
            //定义好数据，从数据库中获取，然后封装返回
            Aggregation aggregation = Aggregation.newAggregation(
                    Aggregation.project("_id", "firstSubject", "secondSubject"),
                    Aggregation.group("firstSubject").first("firstSubject").as("name").push(new Document("id", "$_id").append("secondSubject", "$secondSubject")).as("children"),
                    Aggregation.sort(Sort.by(Sort.Order.asc("children.id")))
            );
            AggregationResults<DisciplineVo> jsonObjects = mongoTemplate.aggregate(aggregation, "学科分类表", DisciplineVo.class);
            List<DisciplineVo> mappedResults = jsonObjects.getMappedResults();
            return R.ok().data("subject", mappedResults);
        }
    ~~~
  
- 获取首页热门论文 /home/getHotPaper

  - 过程

    ~~~Java
    public R getHotPaper(HttpServletRequest httpServletRequest) throws UnsupportedEncodingException {
            Cookie[] cookies = httpServletRequest.getCookies();
        //定义了一个oneLeval列表
            List<String> oneLeval = new ArrayList<>();
            if (cookies!=null) {
                for (Cookie cookie : cookies) {
                    //看看有没有键为 "InterestSubject" 的cookie
                    if ("InterestSubject".equals(cookie.getName())) {
                        //如果有的话看他的值是否包含 "_"
                        if (cookie.getValue().contains("_")) {
                            String[] inters = cookie.getValue().split("_");
                            //包含"_"的话，以这个为分割，将分割后的每个string字符串放入 oneLevel 列表中
                            oneLeval.addAll(Arrays.asList(inters));
                        } else {
                            //不包含"_"的话
                            oneLeval.add(cookie.getValue());
                        }
                    }
                }
            }
            //定义了一个issnLeval列表
            ArrayList<String> issnList = new ArrayList<>();
            //如果oneLevel的大小大于0,就把数据库中的 "_id" 在onelist中的文档，他的的属性为“issnList”的前5个值拿出来放进issnList列表中
            if (oneLeval.size() > 0) {
                Query query = new Query();
                query.addCriteria(Criteria.where("_id").in(oneLeval));
                query.fields().include("issnList");
                List<Discipline> disciplines = mongoTemplate.find(query, Discipline.class);
                for (Discipline discipline : disciplines) {
                    issnList.addAll(discipline.getIssnList().subList(0, discipline.getIssnList().size() >= 5 ? 5 : discipline.getIssnList().size()));
                }
            }
        //根据请求获取用户ID
            String userId = JWTUtils.getUserIdByRequest(httpServletRequest);
    //如果用户id不为null，并且issnList.size() <= 0，就可以去数据库中找到issnList的值并放入
            if (userId != null && issnList.size() <= 0) {
                //根据用户id获取到数据库中获取用户信息
                UserInfo user_id = userInfoMapper.selectOne(new QueryWrapper<UserInfo>().eq("user_id", userId));
                if (user_id != null && user_id.getInterestSubjectHome() != null && user_id.getInterestSubjectHome().size() > 0) {
                    Query query = new Query();
                    query.addCriteria(Criteria.where("_id").in(user_id.getInterestSubjectHome()));
                    query.fields().include("issnList");
                    List<Discipline> disciplines = mongoTemplate.find(query, Discipline.class);
                    for (Discipline discipline : disciplines) {
                        issnList.addAll(discipline.getIssnList().subList(0, discipline.getIssnList().size() >= 5 ? 5 : discipline.getIssnList().size()));
                    }
    
                }
            }
            Calendar calendar = Calendar.getInstance();
            int year = calendar.get(Calendar.YEAR) - 1;
            if (issnList.size() > 0) {
                String pattern = String.format("^.{%s,}$", 10);
                Criteria criteria = Criteria.where("title").regex(pattern, "m");
    
                criteria.and("year").gte(year);
                criteria.and("ISSN").in(issnList);
                criteria.and("authorAndUnits").ne(null);
    
                Aggregation aggregation = Aggregation.newAggregation(
                        Aggregation.match(criteria),
                        Aggregation.sample(10),
                        Aggregation.project("_id", "title", "year", "author", "literatureSources", "ISSN", "authorAndUnits","authorIDs")
                );
                AggregationResults<JournalPapers> aggregate = mongoTemplate.aggregate(aggregation, JournalPapers.class, JournalPapers.class);
                List<JournalPapers> mappedResults = aggregate.getMappedResults();
                ArrayList<HotJournalVo> hotJournalVos = new ArrayList<>();
                for (JournalPapers mappedResult : mappedResults) {
                    HotJournalVo hotJournalVo = new HotJournalVo();
                    BeanUtils.copyProperties(mappedResult, hotJournalVo);
                    hotJournalVo.set_id(Base64Util.encode(mappedResult.get_id()));
                    hotJournalVo.setLiteratureSources(mappedResult.getLiteratureSources().replace(" 北大核心", ""));
                    HashMap<String, String> authorIDs = mappedResult.getAuthorIDs();
                    if (mappedResult.getAuthorAndUnits() != null && mappedResult.getAuthorAndUnits().size() > 0) {
                        for (HashMap<String, String> authorAndUnit : mappedResult.getAuthorAndUnits()) {
                            int index = (int) (Math.random() * 6) + 1;
                            authorAndUnit.put("picture", "https://xueguo.oss-cn-shanghai.aliyuncs.com/xcc/scholar/recommend_head/avatar0" + index + ".png");
                            if(authorIDs!=null && authorIDs.get(authorAndUnit.get("name"))!=null){
                                authorAndUnit.put("id",Base64Util.encode(authorIDs.get(authorAndUnit.get("name"))));
                            }
                        }
                        hotJournalVo.setAuthorAndUnits(mappedResult.getAuthorAndUnits());
                    }
                    hotJournalVos.add(hotJournalVo);
                }
                return R.ok().data("homeJournalPapersVos", hotJournalVos);
            } else {
                Query query = new Query();
                query.fields().include("issnList");
                List<Discipline> disciplines = mongoTemplate.find(query, Discipline.class);
                ArrayList<String> list = new ArrayList<>();
                for (Discipline discipline : disciplines) {
                    list.add(discipline.getIssnList().get(0));
                }
    
    
                String pattern = String.format("^.{%s,}$", 10);
                Criteria criteria = Criteria.where("title").regex(pattern, "m");
    
                criteria.and("year").gte(year);
                criteria.and("ISSN").in(list);
                criteria.and("authorAndUnits").ne(null);
    
                Aggregation aggregation = Aggregation.newAggregation(
                        Aggregation.match(criteria),
                        Aggregation.sample(10),
                        Aggregation.project("_id", "title", "year", "author", "literatureSources", "ISSN", "authorAndUnits","authorIDs")
                );
                AggregationResults<JournalPapers> aggregate = mongoTemplate.aggregate(aggregation, JournalPapers.class, JournalPapers.class);
                List<JournalPapers> mappedResults = aggregate.getMappedResults();
                ArrayList<HotJournalVo> hotJournalVos = new ArrayList<>();
                for (JournalPapers mappedResult : mappedResults) {
                    HotJournalVo hotJournalVo = new HotJournalVo();
                    BeanUtils.copyProperties(mappedResult, hotJournalVo);
                    hotJournalVo.set_id(Base64Util.encode(mappedResult.get_id()));
                    hotJournalVo.setLiteratureSources(mappedResult.getLiteratureSources().replace(" 北大核心", ""));
                    HashMap<String, String> authorIDs = mappedResult.getAuthorIDs();
                    if (mappedResult.getAuthorAndUnits() != null && mappedResult.getAuthorAndUnits().size() > 0) {
                        ArrayList<HashMap<String, String>> maps = new ArrayList<>();
                        for (HashMap<String, String> authorAndUnit : mappedResult.getAuthorAndUnits()) {
                            int index = (int) (Math.random() * 6) + 1;
                            authorAndUnit.put("picture", "https://xueguo.oss-cn-shanghai.aliyuncs.com/xcc/scholar/recommend_head/avatar0" + index + ".png");
                            if(authorIDs!=null && authorIDs.get(authorAndUnit.get("name"))!=null){
                                authorAndUnit.put("id",Base64Util.encode(authorIDs.get(authorAndUnit.get("name"))));
                            }
                        }
                        hotJournalVo.setAuthorAndUnits(mappedResult.getAuthorAndUnits());
                    }
                    hotJournalVos.add(hotJournalVo);
                }
                return R.ok().data("homeJournalPapersVos", hotJournalVos);
            }
        }
    ~~~

  - 相关材料

    <img src="C:\Users\ZHL\AppData\Roaming\Typora\typora-user-images\image-20230529115513469.png" alt="image-20230529115513469" style="zoom:150%;" />

    journal_papers

    ![image-20230529144203509](C:\Users\ZHL\AppData\Roaming\Typora\typora-user-images\image-20230529144203509.png)



### 技术栈分析

- 事务

- 线程池

- 本地缓存

- threadlocal

  ~~~java
  UserHolder
  ~~~

- 验证码

- 二维码

- @CrossOrigin 跨域问题

- base64，加解密问题

- aop

- jwt

- 定时任务

### 性能分析

### 架构分析

### 提供的服务

#### SseService

~~~java
public interface SseService {
    /**
     * 创建SSE
     * @param uid，向本地缓存中放入uid和SseEmitter对象
     * @return
     */
    SseEmitter createSse(String uid);

    /**
     * 关闭SSE
     * @param uid
     */
    void closeSse(String uid);

    /**
     * 客户端发送消息到服务端
     * @param uid
     * @param chatRequest
     */
    ChatResponse sseChat(String uid, ChatRequest chatRequest);
}

    @Override
    public ChatResponse sseChat(String uid, ChatRequest chatRequest) {
        if (StrUtil.isBlank(chatRequest.getMsg())) {
            log.info("参数异常，msg为null", uid);
            throw new BaseException("参数异常，msg不能为空~");
        }
        String messageContext = (String) LocalCache.CACHE.get("msg" + uid);
        Message initMeesage = Message.builder().content("你现在不是OpenAI GPT,你是学知GPT, 是通过GPT（Generative Pre-Training）模型训练的大型语言模型(LLM)，专门为高校师生、科研人员以及从业者服务的生成式AI工具").role(Message.Role.SYSTEM).build();
        List<Message> messages = new ArrayList<>();
        messages.add(initMeesage);
        if (StrUtil.isNotBlank(messageContext)) {
            messages = JSONUtil.toList(messageContext, Message.class);
            if (messages.size() >= 10) {
                messages = messages.subList(1, 10);
            }
            Message currentMessage = Message.builder().content(chatRequest.getMsg()).role(Message.Role.USER).build();
            messages.add(currentMessage);
        } else {
            Message currentMessage = Message.builder().content(chatRequest.getMsg()).role(Message.Role.USER).build();
            messages.add(currentMessage);
        }

        SseEmitter sseEmitter = (SseEmitter) LocalCache.CACHE.get(uid);

        if (sseEmitter == null) {
            log.info("聊天消息推送失败uid:[{}],没有创建连接，请重试。", uid);
            throw new BaseException("聊天消息推送失败uid:[{}],没有创建连接，请重试。~");
        }
        OpenAISSEEventSourceListener openAIEventSourceListener = new OpenAISSEEventSourceListener(sseEmitter);
        ChatCompletion completion = ChatCompletion
                .builder()
                .messages(messages)
                .model(ChatCompletion.Model.GPT_3_5_TURBO.getName())
                .build();
        openAiStreamClient.streamChatCompletion(completion, openAIEventSourceListener);
        LocalCache.CACHE.put("msg" + uid, JSONUtil.toJsonStr(messages), LocalCache.TIMEOUT);
        ChatResponse response = new ChatResponse();
        response.setQuestionTokens(completion.tokens());
        return response;
    }
~~~



### 拦截器

#### UserHolderInterceptor

~~~java
/**
 * 调用接口的时候判断是否包含用户信息，没有的话说明没有登录，那就没有权限，拒绝访问，有的话就在请求前将userid放入threadlocal
 */
@Component
public class UserHolderInterceptor implements HandlerInterceptor {
    @Autowired
    private JWTUtils tokenUtil;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //return true;
        //1、获取请求头
        String token = HttpRequestUtils.getToken(request);
//        String token = request.getHeader("token");
        String requestURI = request.getRequestURI();

        //2、使用工具类，判断token是否有效
        int verifyToken = tokenUtil.verifyToken(token);

        if (verifyToken == 200) {        //200 表示token正常
            response.setStatus(200);
//            获取载荷信息
            Map<String, Claim> claims = tokenUtil.getClaims(token);
//            把userid放入threadlocal
            String nickName = claims.get("userId").asString();
            UserHolder.set(nickName);
            return true;
        }
        return true;
    }
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
//        将userid移除threadlocal
        UserHolder.remove();
    }

}
~~~



#### LoginAuthInterceptor

~~~java
/**
 * 调用接口的时候判断是否包含用户信息，没有的话说明没有登录，那就没有权限，拒绝访问
 */
@Component
public class LoginAuthInterceptor implements HandlerInterceptor {
    @Autowired
    private JWTUtils tokenUtil;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //return true;
        //1、获取cookie中的token值
        String token = HttpRequestUtils.getToken(request);
//        String token = request.getHeader("token");
        String requestURI = request.getRequestURI();

        //2、使用工具类，判断token是否有效
        int verifyToken = tokenUtil.verifyToken(token);

        if (verifyToken == 200) {        //200 表示token正常
            response.setStatus(200);
            Map<String, Claim> claims = tokenUtil.getClaims(token);
            String nickName = claims.get("userId").asString();
            UserHolder.set(nickName);
            return true;
        } else if (verifyToken == 501) {
            ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
            response.setCharacterEncoding("UTF-8"); //解决中文乱码
            response.getWriter()
                    .write(objectMapper.writeValueAsString(R.error(100501, "登录过期请重新登录")));
            return false;
        } else {
            ObjectMapper objectMapper = new ObjectMapper();
            response.setCharacterEncoding("UTF-8");
            response.getWriter()
                    .write(objectMapper.writeValueAsString(R.error(100503, "请先登录")));
            return false;
        }
    }
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
        UserHolder.remove();
    }

}
~~~



#### RateLimteInterceptor

~~~java
/**
 * 调用接口的时候判断是否包含用户信息，没有的话说明没有登录，那就没有权限，拒绝访问
 * token有效的话   
 * scholar_userid_limit_5min" + nickName 作为 redis 的key，访问次数作为value
 * 如果5分钟内访问超过10次，报错，并且存入   captcha_userid_"+nickName:""
 * 如果token存在7天了拦截，超过1000次拦截
 * 没有token的话
 * "scholar_ip_limit_5min" + ipAddr 作为 redis的key，访问次数为value
 * 意思是将限制同一个IP的次数
 * 
 */
@Component
public class RateLimteInterceptor implements HandlerInterceptor {
    @Autowired
    private JWTUtils tokenUtil;

    @Autowired
    private MongoTemplate mongoTemplate;

    @Autowired
    private StringRedisTemplate redisTemplate;

    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //return true;
        //1、获取请求头
        String token = HttpRequestUtils.getToken(request);
//        String token = request.getHeader("token");
        String requestURI = request.getRequestURI();


        //2、使用工具类，判断token是否有效
        int verifyToken = tokenUtil.verifyToken(token);



        if (verifyToken == 200) {        //200 表示token正常
            response.setStatus(200);
            Map<String, Claim> claims = tokenUtil.getClaims(token);
            String nickName = claims.get("userId").asString();
            String key = "scholar_userid_limit_5min" + nickName;  // 使用客户端IP作为key
            String key2 = "scholar_userid_limit_24h" + nickName;  // 使用客户端IP作为key
            String value = redisTemplate.opsForValue().get(key);
            String value2 = redisTemplate.opsForValue().get(key2);
            int count = 1;
            int count2 = 1;
            if (value == null) {
                redisTemplate.opsForValue().set(key, "1", 5, TimeUnit.MINUTES);  // 设置key的过期时间为24小时
            }else{
                count = Integer.parseInt(value);
                redisTemplate.opsForValue().increment(key);
            }
            if (value2 == null) {
                redisTemplate.opsForValue().set(key2, "1", 24, TimeUnit.HOURS);  // 设置key的过期时间为24小时
            }else{
                count2 = Integer.parseInt(value2);
                redisTemplate.opsForValue().increment(key2);
            }
            if(redisTemplate.hasKey("captcha_userid_"+nickName)){
                ObjectMapper objectMapper = new ObjectMapper();
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100407, "requet over limit")));
                return false;
            }
//            if (!RateLimitLocalCache.CACHE.containsKey(nickName)) {
//                RateLimitLocalCache.CACHE.put(nickName, 1);
//            } else {
//                RateLimitLocalCache.CACHE.put(nickName, RateLimitLocalCache.CACHE.get(nickName) + 1);
//            }

            Calendar cal = Calendar.getInstance();
            cal.setTime(new Date());
            cal.add(Calendar.DATE, -7);
            Date dateBefore7Days = cal.getTime();
            Query query = new Query();
            query.addCriteria(Criteria.where("userId").is(nickName));
            query.addCriteria(Criteria.where("startDate").gte(dateBefore7Days));
            ForbidanInfo one = mongoTemplate.findOne(query, ForbidanInfo.class);
            if (one != null) {
                ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100408, "requet over limit,user is baned")));
                return false;
            }


            if (count > 10) {
                ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100407, "requet over limit")));
                redisTemplate.opsForValue().set("captcha_userid_"+nickName,"");
                return false;
            }
            if (count2 > 1000) {
                ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100408, "requet over limit,user is baned")));
                ForbidanInfo forbidanInfo = new ForbidanInfo(null, nickName, null, 7, new Date());
                mongoTemplate.insert(forbidanInfo);
                return false;
            }
            return true;
        } else{
            String ipAddr = IPUtils.getIpAddr(request); //获取ip地址
            String key = "scholar_ip_limit_5min" + ipAddr;  // 使用客户端IP作为key
            String key2 = "scholar_ip_limit_24h" + ipAddr;  // 使用客户端IP作为key
            String value = redisTemplate.opsForValue().get(key);
            String value2 = redisTemplate.opsForValue().get(key2);
            int count = 1;
            int count2 = 1;
            if (value == null) {
                redisTemplate.opsForValue().set(key, "1", 5, TimeUnit.MINUTES);  // 设置key的过期时间为24小时
            }else{
                count = Integer.parseInt(value);
                redisTemplate.opsForValue().increment(key);
            }
            if (value2 == null) {
                redisTemplate.opsForValue().set(key2, "1", 24, TimeUnit.HOURS);  // 设置key的过期时间为24小时
            }else{
                count2 = Integer.parseInt(value2);
                redisTemplate.opsForValue().increment(key2);
            }
            if(redisTemplate.hasKey("captcha_ip_"+ipAddr)){
                ObjectMapper objectMapper = new ObjectMapper();
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100407, "requet over limit")));
                return false;
            }
            if (count > 10) {
                ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100407, "requet over limit")));
                redisTemplate.opsForValue().set("captcha_ip_"+ipAddr,"");
                return false;
            }


            Calendar cal = Calendar.getInstance();
            cal.setTime(new Date());
            cal.add(Calendar.DATE, -7);
            Date dateBefore7Days = cal.getTime();
            Query query = new Query();
            query.addCriteria(Criteria.where("ip").is(ipAddr));
            query.addCriteria(Criteria.where("startDate").gte(dateBefore7Days));
            ForbidanInfo one = mongoTemplate.findOne(query, ForbidanInfo.class);
            if (one != null) {
                ObjectMapper objectMapper = new ObjectMapper();
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100408, "requet over limit,ip is baned")));
                return false;
            }
            if (count2 > 1000) {
                ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                response.getWriter()
                        .write(objectMapper.writeValueAsString(R.error(100408, "requet over limit,ip is baned")));
                ForbidanInfo forbidanInfo = new ForbidanInfo(null, null, ipAddr, 7, new Date());
                mongoTemplate.insert(forbidanInfo);
                return false;
            }
            return true;
        }
    }
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
    }

}
~~~



#### NoVipLimteInterceptor

~~~java
/**
 * 调用接口的时候判断是否包含用户信息，没有的话说明没有登录，那就没有权限，拒绝访问
 * token正常的话
 * 判断会员有没有，没有的话限制gpt，学生主页，下载什么的。次数先判断是不是vip，是不是vip通过确认和过期时间确定。然后vip和一般用户的key不一样，对应的value是限制次数
 * token没有的话
 * 根据ip限制次数
 */
@Component
public class NoVipLimteInterceptor implements HandlerInterceptor {
    @Autowired
    private JWTUtils tokenUtil;

    @Autowired
    private MongoTemplate mongoTemplate;

    @Autowired
    VipUserService vipUserService;

    @Autowired
    private StringRedisTemplate redisTemplate;

//这个方法的作用是计算当前时间距离指定未来日期的午夜（即零点）之间的秒数
    private long getSecondsTillNextDay(int day) {
        LocalDateTime nextDay = LocalDateTime.of(LocalDate.now().plusDays(day), LocalTime.MIDNIGHT);
        return LocalDateTime.now().until(nextDay, ChronoUnit.SECONDS);
    }
    @Override
    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {
        //return true;
        //1、获取请求头
        String token = HttpRequestUtils.getToken(request);
//        String token = request.getHeader("token");
        String requestURI = request.getRequestURI();


        //2、使用工具类，判断token是否有效
        int verifyToken = tokenUtil.verifyToken(token);

        String servletPath = request.getServletPath();
        if (verifyToken == 200) {        //200 表示token正常
            response.setStatus(200);
            Map<String, Claim> claims = tokenUtil.getClaims(token);
            String uid = claims.get("userId").asString();
            boolean success = vipUserService.validVipStatus(uid);
            String path = servletPath;
            if(servletPath.startsWith("/scholarHomePage")){
                //访问学者主页获取 详情接口的键
                path = "/scholar/getDetail";
            }
            String key = "noviplimt:"+path+"_" + uid;
            if(success){
                key = "viplimt:"+path+"_" + uid;
            }
            String value = redisTemplate.opsForValue().get(key);
            int dayCount = 1;
            if (servletPath.equals("/pdf/download")) {
                dayCount = 30;
            }
            long secondsTillNextDay = getSecondsTillNextDay(dayCount);
            if (value == null) {
                redisTemplate.opsForValue().set(key, "1", secondsTillNextDay, TimeUnit.SECONDS);  // 设置key的过期时间为当前时间到次日0点的时间间隔
                return true;
            }
            int count = Integer.parseInt(value);
            if(!success){
                if(servletPath.equals("/gpt/chat")){
                    //gpt限制
                    if (count<10) {
                        redisTemplate.opsForValue().increment(key);
                        return true;
                    } else {
                        response.setContentType("application/json");
                        response.setCharacterEncoding("UTF-8");
                        ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                        response.getWriter()
                                .write(objectMapper.writeValueAsString(R.error(NOVIP_LIMIT.getCode(), NOVIP_LIMIT.getMessage())));
                        return false;
                    }
                }else if(servletPath.equals("/scholar/getDetail") || servletPath.startsWith("/scholarHomePage")){
                    //学者主页限制
                    if (count<5 && servletPath.equals("/scholar/getDetail")) {
                        redisTemplate.opsForValue().increment(key);
                        return true;
                    } else if (count<6 && !servletPath.equals("/scholar/getDetail")) {
                        return true;
                    } else {
                        response.setContentType("application/json");
                        response.setCharacterEncoding("UTF-8");
                        ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                        response.getWriter()
                                .write(objectMapper.writeValueAsString(R.error(NOVIP_LIMIT.getCode(), NOVIP_LIMIT.getMessage())));
                        return false;
                    }
                }else{
                    response.setContentType("application/json");
                    response.setCharacterEncoding("UTF-8");
                    ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                    response.getWriter()
                            .write(objectMapper.writeValueAsString(R.error(NOVIP_LIMIT.getCode(), NOVIP_LIMIT.getMessage())));
                    return false;
                }
            }else{
                if(servletPath.equals("/scholar/getDetail") || servletPath.startsWith("/scholarHomePage")){
                    //学者主页 会员限制 100条/天(23.8.29:50条/天)
                    if (count<50 && servletPath.equals("/scholar/getDetail")) {
                        redisTemplate.opsForValue().increment(key);
                        return true;
                    } else if (count<51 && !servletPath.equals("/scholar/getDetail")) {
                        return true;
                    } {
                        response.setContentType("application/json");
                        response.setCharacterEncoding("UTF-8");
                        ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                        response.getWriter()
                                .write(objectMapper.writeValueAsString(R.error(VIP_SCHOLAR_LIMIT.getCode(), VIP_SCHOLAR_LIMIT.getMessage())));
                        return false;
                    }
                }else if(servletPath.equals("/pdf/download")){
                    //pdf下载 会员限制 200次/月
                    if (count<200) {
                        redisTemplate.opsForValue().increment(key);
                        return true;
                    } else {
                        response.setContentType("application/json");
                        response.setCharacterEncoding("UTF-8");
                        ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                        response.getWriter()
                                .write(objectMapper.writeValueAsString(R.error(VIP_PDF_LIMIT.getCode(), VIP_PDF_LIMIT.getMessage())));
                        return false;
                    }
                }else{
                    return true;
                }
            }
        } else{
            if (servletPath.equals("/scholar/getDetail") || servletPath.startsWith("/scholarHomePage")) {
                String ipAddr = IPUtils.getIpAddr(request);
                String key = "noviplimt:"+ipAddr;
                String value = redisTemplate.opsForValue().get(key);
                int dayCount = 1;
                long secondsTillNextDay = getSecondsTillNextDay(dayCount);
                if (value == null) {
                    redisTemplate.opsForValue().set(key, "1", secondsTillNextDay, TimeUnit.SECONDS);  // 设置key的过期时间为当前时间到次日0点的时间间隔
                    return true;
                }
                int count = Integer.parseInt(value);
                if (count<5) {
                    redisTemplate.opsForValue().increment(key);
                    return true;
                } else {
                    response.setContentType("application/json");
                    response.setCharacterEncoding("UTF-8");
                    ObjectMapper objectMapper = new ObjectMapper();//501表示时间过期
                    response.getWriter()
                            .write(objectMapper.writeValueAsString(R.error(NOVIP_LIMIT.getCode(), NOVIP_LIMIT.getMessage())));
                    return false;
                }
            }

            ObjectMapper objectMapper = new ObjectMapper();
            response.getWriter()
                    .write(objectMapper.writeValueAsString(R.error(NOVIP_LIMIT.getCode(), NOVIP_LIMIT.getMessage())));
            return false;
        }
    }
    @Override
    public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception {
    }

}
~~~



### 监听器



### 问题
